{"version":3,"sources":["../lib/koel.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eAwBqB,QAAQ,UAAR,C;;IAAd,U,YAAA,U;;gBACc,QAAQ,UAAR,C;;IAAd,U,aAAA,U;;gBACa,QAAQ,SAAR,C;;IAAb,S,aAAA,S;;gBACY,QAAQ,QAAR,C;;IAAZ,Q,aAAA,Q;;gBACW,QAAQ,OAAR,C;;IAAX,O,aAAA,O;;gBACY,QAAQ,QAAR,C;;IAAZ,Q,aAAA,Q;;gBACc,QAAQ,UAAR,C;;IAAd,U,aAAA,U;;gBACgB,QAAQ,SAAR,C;;IAAhB,Y,aAAA,Y;;gBACa,QAAQ,SAAR,C;;IAAb,S,aAAA,S;AAEA,IAAM,0CAAiB,CAAC,QAAD,EAAW,QAAX,EAAqB,SAArB,CAAvB;;AAEA,IAAM,4CAAgB;AAC3B,QAD2B,oBACZ;AAAA,sCAAL,IAAK;AAAL,UAAK;AAAA;;AACb,8CAAW,UAAX,gBAAyB,IAAzB;AACD,GAH0B;AAK3B,QAL2B,oBAKZ;AAAA,uCAAL,IAAK;AAAL,UAAK;AAAA;;AACb,8CAAW,UAAX,gBAAyB,IAAzB;AACD,GAP0B;AAS3B,OAT2B,iBASrB,IATqB,EAShB;AACT,QAAG,gBAAgB,MAAnB,EAA0B;AACxB,UAAM,SAAS,KAAK,QAAL,GAAgB,KAAhB,CAAsB,GAAtB,CAAf;AACA,UAAM,QAAQ,OAAO,CAAP,CAAd;AACA,UAAM,QAAQ,OAAO,CAAP,CAAd;AACA,aAAO,IAAI,SAAJ,CAAc,EAAC,YAAD,EAAQ,YAAR,EAAd,CAAP;AACD;AACD,QAAG,OAAO,IAAP,KAAe,QAAlB,EAA2B;AACzB,UAAM,SAAQ,IAAd;AACA,aAAO,IAAI,SAAJ,CAAc,EAAC,aAAD,EAAd,CAAP;AACD;AACD,WAAO,IAAI,SAAJ,CAAc,IAAd,CAAP;AACD,GArB0B;AAuB3B,MAvB2B,kBAuBd;AAAA,uCAAL,IAAK;AAAL,UAAK;AAAA;;AACX,8CAAW,QAAX,gBAAuB,IAAvB;AACD,GAzB0B;AA2B3B,aA3B2B,yBA2BP;AAAA,uCAAL,IAAK;AAAL,UAAK;AAAA;;AAClB,QAAM,SAAS,KAAK,MAAL,KAAgB,CAAhB,IAAqB,KAAK,CAAL,aAAmB,KAAxC,GAA8C,IAA9C,GAAmD,CAAC,KAAK,CAAL,CAAD,CAAlE;AACA,WAAO,IAAI,QAAJ,CAAa,EAAC,cAAD,EAAb,CAAP;AACD,GA9B0B;AAgC3B,KAhC2B,iBAgCf;AAAA,uCAAL,IAAK;AAAL,UAAK;AAAA;;AACV,8CAAW,OAAX,gBAAsB,IAAtB;AACD,GAlC0B;AAoC3B,UApC2B,sBAoCV;AAAA,uCAAL,IAAK;AAAL,UAAK;AAAA;;AACf,8CAAW,YAAX,gBAA2B,IAA3B;AACD,GAtC0B;AAwC3B,QAxC2B,kBAwCpB,KAxCoB,EAwCd;AAAA,eAIP,SAAO,EAJA;;AAAA,yBAET,IAFS;AAAA,QAET,IAFS,6BAEF,EAFE;;AAAA,QAGN,IAHM;;AAKX,QAAM,UAAU,KAAK,cAAL,CAAoB,IAApB,CAAhB;AACA,WAAO,IAAI,UAAJ,YAAgB,MAAM,OAAtB,IAAkC,IAAlC,EAAP;AACD,GA/C0B;AAiD3B,OAjD2B,iBAiDrB,KAjDqB,EAiDf;AAAA;;AAAA,gBAIN,SAAS,EAJH;;AAAA,4BAER,KAFQ;AAAA,QAER,KAFQ,+BAEA,EAFA;;AAAA,QAGL,IAHK;;AAKV,QAAM,WAAW,MAAM,GAAN,CAAU,UAAC,IAAD;AAAA,aAAQ,MAAK,cAAL,CAAoB,IAApB,CAAR;AAAA,KAAV,CAAjB;AACA,WAAO,IAAI,SAAJ,YAAe,OAAO,QAAtB,IAAmC,IAAnC,EAAP;AACD;AAxD0B,CAAtB;;AA2DA,IAAM,4CAAkB,CAC7B;AACE,OADF,iBACQ,KADR,EACc;AACV,WAAO,iBAAiB,MAAxB;AACD,GAHH;AAIE,KAJF,eAIM,KAJN,EAIa,OAJb,EAIqB;AACjB,WAAO,QAAQ,KAAR,CAAc,KAAd,CAAP;AACD;AANH,CAD6B,EAU7B;AACE,OADF,iBACQ,KADR,EACc;AACV,WAAO,MAAM,OAAN,CAAc,KAAd,CAAP;AACD,GAHH;AAIE,KAJF,eAIM,KAJN,EAIa,OAJb,EAIqB;AACjB,WAAO,QAAQ,KAAR,CAAc,IAAd,CAAmB,IAAnB,EAAyB,EAAC,YAAD,EAAzB,CAAP;AACD;AANH,CAV6B,EAmB7B;AACE,OADF,iBACQ,KADR,EACc;AACV,WAAO,iBAAiB,IAAxB;AACD,GAHH;AAIE,KAJF,eAIM,KAJN,EAIa,OAJb,EAIqB;AACjB,WAAO,QAAQ,IAAR,CAAa,KAAb,CAAP;AACD;AANH,CAnB6B,EA4B7B;AACE,OADF,iBACQ,KADR,EACc;AACV,QAAM,cAAc,KAAd,yCAAc,KAAd,CAAN;AACA,WAAO,CAAE,UAAU,KAAK,CAAhB,IAAuB,eAAe,OAAf,CAAuB,IAAvB,IAA+B,CAAC,CAAvD,IAA8D,UAAU,IAAzE,KAAoF,CAAC,CAAC,SAAO,EAAR,EAAY,IAAxG;AACD,GAJH;AAKE,KALF,eAKM,KALN,EAKa,OALb,EAKqB;AACjB,WAAO,QAAQ,QAAR,CAAiB,KAAjB,CAAP;AACD;AAPH,CA5B6B,EAsC7B;AACE,OADF,iBACQ,KADR,EACc;AACV,WAAQ,iBAAiB,MAAlB,IAA8B,CAAC,MAAM,IAA5C;AACD,GAHH;AAIE,KAJF,eAIM,IAJN,EAIY,OAJZ,EAIoB;AAChB,WAAO,QAAQ,MAAR,CAAe,IAAf,CAAoB,IAApB,EAA0B,IAA1B,CAAP;AACD;AANH,CAtC6B,CAAxB;;AAiDP,IAAM,OAAO,SAAP,IAAO,CAAC,KAAD,EAAQ,SAAR,EAAoB;AAC/B,MAAI,UAAU,IAAd,EAAoB;AAClB,UAAM,IAAI,SAAJ,CAAc,kCAAd,CAAN;AACD;AACD,MAAI,OAAO,SAAP,KAAqB,UAAzB,EAAqC;AACnC,UAAM,IAAI,SAAJ,CAAc,8BAAd,CAAN;AACD;AACD,MAAI,OAAO,OAAO,KAAP,CAAX;AACA,MAAI,SAAS,KAAK,MAAL,KAAgB,CAA7B;AACA,MAAI,UAAU,WAAU,CAAV,CAAd;AACA,MAAI,cAAJ;;AAEA,OAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAApB,EAA4B,GAA5B,EAAiC;AAC/B,YAAQ,KAAK,CAAL,CAAR;AACA,QAAI,UAAU,IAAV,CAAe,OAAf,EAAwB,KAAxB,EAA+B,CAA/B,EAAkC,IAAlC,CAAJ,EAA6C;AAC3C,aAAO,KAAP;AACD;AACF;AACD,SAAO,SAAP;AACD,CAnBD;;IAqBa,I,WAAA,I;AACX,gBAAY,MAAZ,EAAiC;AAAA,QAAb,OAAa,yDAAH,EAAG;;AAAA;;AAC/B,SAAK,MAAL,GAAc,MAAd;AACA,SAAK,OAAL,GAAe,OAAO,MAAP,CAAc,EAAd,EAAkB,eAAlB,EAAmC,QAAQ,OAA3C,CAAf;AACA,SAAK,cAAL,GAAsB,QAAQ,cAAR,IAA0B,eAAhD;AACA,SAAK,OAAL,GAAe,KAAK,WAAL,CAAiB,MAAjB,CAAf;AACD;;;;+BAES;AACR,aAAO,KAAK,SAAL,CAAe,KAAK,OAApB,EAA6B,IAA7B,EAAmC,IAAnC,CAAP;AACD;;;6BAEO;AACN,aAAO,KAAK,KAAL,CAAW,KAAK,SAAL,CAAe,KAAK,OAApB,CAAX,CAAP;AACD;;;mCAEc,M,EAAO;AAAA;;AACpB,UAAG,OAAO,OAAO,IAAd,KAAsB,QAAzB,EAAkC;AAChC,eAAO,MAAP;AACD;AACD,UAAM,OAAO,OAAO,IAAP,CAAY,MAAZ,CAAb;AACA,aAAO,KAAK,MAAL,CAAY,UAAC,CAAD,EAAI,GAAJ,EAAU;AAC3B,YAAM,WAAW,OAAO,GAAP,CAAjB;AACA,YAAM,SAAS,KAAK,OAAK,cAAV,EAA0B,UAAC,MAAD,EAAU;AACjD,iBAAO,OAAO,KAAP,CAAa,QAAb,CAAP;AACD,SAFc,CAAf;AAGA,YAAI,QAAQ,SAAO,OAAO,GAAP,CAAW,IAAX,SAAsB,QAAtB,EAAgC,OAAK,OAArC,CAAP,GAAqD,OAAO,GAAP,CAAjE;AACA,UAAE,GAAF,IAAS,KAAT;AACA,eAAO,CAAP;AACD,OARM,EAQJ,EARI,CAAP;AASD;;;;;;;;;;;;;;;;;;;;;;;;;gCAuBW,M,EAAO;AAAA;;AACjB,UAAM,cAAc,OAAO,IAAP,CAAY,KAAK,OAAjB,CAApB;AACA,UAAM,UAAU,YAAY,GAAZ,CAAgB,UAAC,IAAD;AAAA,eAAQ,OAAK,OAAL,CAAa,IAAb,EAAmB,IAAnB,QAAR;AAAA,OAAhB,CAAhB;AACA,UAAM,MAAM,OAAO,MAAP,KAAiB,QAAjB,GAA0B,MAA1B,GAAiC,KAAK,SAAL,CAAe,MAAf,EAAuB,IAAvB,EAA6B,IAA7B,CAA7C;AACA,UAAM,qBAAmB,MAAnB,MAAN;AACA,UAAM,IAAI,IAAI,QAAJ,CAAa,WAAb,EAA0B,MAA1B,CAAV;;;AAGA,UAAM,UAAU,sCAAK,OAAL,EAAhB;AACA,aAAO,KAAK,cAAL,CAAoB,OAApB,CAAP;AACD;;;;;;AACF","file":"koel.js","sourcesContent":["\n/*\n{\n  \"required\": string(),\n  \"optional\": string().optional(),\n  \"link\": link(\"collection.key[=collection.display]\"),\n  \"number\": number(),\n  \"regex\": /someregex/gi,\n  \"anything\": any(),\n  \"date\": date(),\n  \"object\": {\n    ...\n  },\n  \"array\": [\n    string(), // Allow Strings\n    number(), // Allow Numbers\n    ...\n  ],\n  \"default\": string().default('value'),\n  \"enumeration\": enumeration('some', 'value'), // Only 'some' or 'value' will be allowed\n  \"constant\": \"value\"|0|true,\n}\n*/\n\nconst {KoelString} = require('./string');\nconst {KoelNumber} = require('./number');\nconst {KoelRegex} = require('./regex');\nconst {KoelEnum} = require('./enum');\nconst {KoelAny} = require('./any');\nconst {KoelDate} = require('./date');\nconst {KoelObject} = require('./object');\nconst {KoelConstant} = require('./const');\nconst {KoelArray} = require('./array');\n\nexport const CONSTANT_TYPES = ['string', 'number', 'boolean'];\n\nexport const DEFAULT_MAPPERS={\n  string(...args){\n    return new KoelString(...args);\n  },\n\n  number(...args){\n    return new KoelNumber(...args);\n  },\n\n  regex(expr){\n    if(expr instanceof RegExp){\n      const source = expr.toString().split('/');\n      const flags = source[2];\n      const regex = source[1];\n      return new KoelRegex({regex, flags});\n    }\n    if(typeof(expr)==='string'){\n      const regex = expr;\n      return new KoelRegex({regex});\n    }\n    return new KoelRegex(expr);\n  },\n\n  date(...args){\n    return new KoelDate(...args);\n  },\n\n  enumeration(...args){\n    const allows = args.length === 1 && args[0] instanceof Array?args:[args[0]];\n    return new KoelEnum({allows});\n  },\n\n  any(...args){\n    return new KoelAny(...args);\n  },\n\n  constant(...args){\n    return new KoelConstant(...args);\n  },\n\n  object(proto){\n    const {\n      keys = {},\n      ...rest\n    } = proto||{};\n    const newKeys = this.replaceSpecial(keys);\n    return new KoelObject({keys: newKeys, ...rest});\n  },\n\n  array(proto){\n    const {\n      items = [],\n      ...rest\n    } = proto || {};\n    const newItems = items.map((item)=>this.replaceSpecial(item));\n    return new KoelArray({items: newItems, ...rest});\n  },\n};\n\nexport const SPECIAL_MAPPERS = [\n  {\n    check(value){\n      return value instanceof RegExp;\n    },\n    map(value, mappers){\n      return mappers.regex(value);\n    }\n  },\n\n  {\n    check(value){\n      return Array.isArray(value);\n    },\n    map(items, mappers){\n      return mappers.array.call(this, {items});\n    }\n  },\n\n  {\n    check(value){\n      return value instanceof Date;\n    },\n    map(value, mappers){\n      return mappers.date(value);\n    }\n  },\n\n  {\n    check(value){\n      const type = typeof(value);\n      return ((value === void 0) || (CONSTANT_TYPES.indexOf(type) > -1) || (value === null)) && (!(value||{}).type);\n    },\n    map(value, mappers){\n      return mappers.constant(value);\n    }\n  },\n\n  {\n    check(value){\n      return (value instanceof Object) && (!value.type);\n    },\n    map(keys, mappers){\n      return mappers.object.call(this, keys);\n    }\n  },\n\n];\n\nconst find = (array, predicate)=>{\n  if (array === null) {\n    throw new TypeError('find called on null or undefined');\n  }\n  if (typeof predicate !== 'function') {\n    throw new TypeError('predicate must be a function');\n  }\n  let list = Object(array);\n  let length = list.length >>> 0;\n  let thisArg = arguments[1];\n  let value;\n\n  for (let i = 0; i < length; i++) {\n    value = list[i];\n    if (predicate.call(thisArg, value, i, list)) {\n      return value;\n    }\n  }\n  return undefined;\n};\n\nexport class Koel{\n  constructor(schema, options = {}){\n    this.schema = schema;\n    this.mappers = Object.assign({}, DEFAULT_MAPPERS, options.mappers);\n    this.specialMappers = options.specialMappers || SPECIAL_MAPPERS;\n    this._schema = this.parseSchema(schema);\n  }\n\n  toString(){\n    return JSON.stringify(this._schema, null, '  ');\n  }\n\n  toJSON(){\n    return JSON.parse(JSON.stringify(this._schema));\n  }\n\n  replaceSpecial(schema){\n    if(typeof(schema.type)==='string'){\n      return schema;\n    }\n    const keys = Object.keys(schema);\n    return keys.reduce((s, key)=>{\n      const rawValue = schema[key];\n      const mapper = find(this.specialMappers, (mapper)=>{\n        return mapper.check(rawValue);\n      });\n      let value = mapper?mapper.map.call(this, rawValue, this.mappers):schema[key];\n      s[key] = value;\n      return s;\n    }, {});\n  }\n\n/*\n  processPrefixes(schema){\n    const keys = Object.keys(schema);\n    const prefixes = this.prefixes;\n    const response = keys.reduce((s, key)=>{\n      let value = schema[key];\n      let idx = 0;\n      let char = key.charAt(idx);\n      let handler;\n      while(handler = prefixes[char]){\n        value = handler.call(this, value, key, schema);\n        idx++;\n        char = key.charAt(idx);\n      }\n      s[key.substr(idx)] = value;\n      return s;\n    }, {});\n    return response;\n  }\n*/\n\n  parseSchema(schema){\n    const mapperNames = Object.keys(this.mappers);\n    const mappers = mapperNames.map((name)=>this.mappers[name].bind(this));\n    const src = typeof(schema)==='string'?schema:JSON.stringify(schema, null, '  ');\n    const mapSrc = `return ${schema};`;\n    const f = new Function(mapperNames, mapSrc);\n    //const prefixedSchema = f(...mappers);\n    //const _schema = this.processPrefixes(prefixedSchema);\n    const _schema = f(...mappers);\n    return this.replaceSpecial(_schema);\n  }\n};\n"]}